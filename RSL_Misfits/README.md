# Notes for RSL misfit calculation



## About dataset

> The RSL datasets we use in this study are all from published studies, and they include: (1) 18 sites in North America and 12 sites in Fennoscandia sites in the formerly ice covered regions or at a relatively small distance from the ice margins used in Peltier et al., [2015] for ICE-6G (they are denoted as P_NA and P_FN, respectively) (Figure 3), (2) RSL data in North America in Lambeck et al. [2017], which has been built up from Tushingham and Peltier [1991] dataset, and includes 371 sites covering the Hudson Bay, the northern part of North America, the Pacific and Atlantic coast of North America (denoted as L_NA), (3) RSL dataset along the eastern Canadian coast published in Vacchi et al. [2018] which is grouped into 34 sites describing the postglacial evolution of eastern Canada in the last ~16 ka (denoted as V_NA), (4) RSL dataset for the Pacific coast of central North America by Engelhart et al. [2015] and for the Atlantic coast of the United States published by Engelhart et al. [2012], which have 28 sites (denoted as E_NA), and (5) 36 far-field RSL sites located on oceanic islands in Pacific Ocean and India Ocean and along the coasts of Australia and Asia (denoted as L_FF) (Figure 3). All these datasets are downloaded from supplementary data of the published work referenced above, except for P_NA and P_FN datasets that we **digitized from Peltier et al. [2015]**.

(copied from Kaixuan's paper)
(Peltier's data are messy. May start from others' datasets, like Lambeck)


## Folders of Scripts & Data

* **gridresearch_results_ICE6G_batch**: this is the main folder for computing misfit, given model prediction.
Under it:
* **code_script.dir/**: scripts to compute misfit.
* **grid001/**: a example of model prediction I copied from haro:/home/khuan/ICE6G_results_0.1grids/grid001. It has spherical harmonics computed from Fortran code, and postprocessed RSL prediction for sites corresponding to the RSL dataset (RSL_OBS).
* demo_script/: Some simple demos, like plotting RSL data.

**RSL_OBS**: RSL dataset and scripts for reading
* read_rsl_global_grids.py: group RSL history for a regular global map (deg-by-deg; if that site has RSL data nearby.)

Notes:
* scripts may be written for python2, may need small modifications if using python3.
* may have problem of mixing of 'tab' and 'space', and inconsistent indentation. Can use `sed` to fix or fix manually.  



## How to: Compute misfit between model prediction with one RSL dataset

The scripts starting from "calc_rms" under code_script.dir/ are used for misfit calculation. 

Below I use `calc_rms_lambekc_rsl.py` as an example.

### Notes for `calc_rms_lambekc_rsl.py`:

It requires two things:
1. model prediction (from analytic code).
2. one RSL dataset to compare with.


**model prediction from analytic code**: 

* Require `PREFIX/RSL_ICE6G_grids_compr_lambeck_farfield.txt`, together with `years.reverse`. 
  * an example: PREFIX = grid001. copied from /home/khuan/ICE6G_results_0.1grids/gridxxx
  * This `RSL_ICE6G_grids_compr_lambeck_farfield.txt` file can be generated by **code_script.dir/ts_location_output_fortran.py**. Which reads site location from file RSL_site_location_Lambeck_NA_all.txt, then computes model predicted RSL history from spherical harmonics coefficients computed from Fortran code.


**RSL dataset**:

* Lambeck_etal_2014_PNAS_supp_edit.xlsx & 'Sitename_Lambeck_FarField_selected.txt' for selected sites.

### Lambeck NA dataset

As far as I know, the `RSL_site_location_Lambeck_NA_all.txt` corresponds to `RSL_dataset_Lambeck_NA/rsl_dataset_lambeck_NA.xlsx`



## Notes about Peltier NA dataset

`rsl_Peltier_2015paper_NA.xls`, `Sitename_Peltier_digitized_NA.txt` and `RSL_site_location_Peltier_digitized_NA.txt`


Notes about multiple_calc_rms_peltier_rsl.py

``` python
for idx_site in range(selectedUTKEY):
    # idx_site: the current selected site's id
    
    # Note, each site has multiple records with different ages. And each record has uncertainty in age and rsl.
    # so, age will has ageMin ageMax as bounds, rsl will have rslMin rslMax as bounds.
    
    # get model prediction for rsl
    rslModelAtSite = rslModelAtSite - rslModelAtSite[-1] # get model prediction, a list, size: len(years.reverse)
    		# - rslModelAtSite[-1] to get rsl relative to present day
    
    # find index for this site in the excel file, to read data from excel for this site
    UTKEYAtSite = selectedUTKEY[idx_site].strip()  
    idx_UTKEY = (UTKEYAtSite == UTKEY)
    idx_UTKEY # => a list of all rows corresponding to this site, 
    			# each row has data of time, rsl (and their bound)
    
    # read (time, rsl) record from excel
    rslDataAtSite, rslDataMinAtSite, rslDataMaxAtSite 
    # each one is an array of data (records with different ages, Min Max is the bound or uncertainty of the record)
    ageAtSite, ageMinAtSite, ageMaxAtSite,
    
    # compute uncertainty for rsl data: computed from Min and Max
    # a list of uncertainty of rsl, for each record of this site
    rslDataError = np.stack((np.abs(rslDataAtSite-rslDataMinAtSite), np.abs(rslDataMaxAtSite-rslDataAtSite)), axis=0).max(axis=0)

    
    # at this point, this site has rsl records of (sparse) ages, 
    # so we need find our modelled rsl at those ages for this site!
    # Note, the ageAtSite is different from our modelled ages (i.e. the years.reverser)
    
    # This is achieved by finding which one in our years.reverse matchs the age of that record best.
    idx_rslModel[time_count] = distanceTime.argmin()
    idx_rslModel # store a list of index: 
    	# rslModelAtSite[idx_rslModel[0]] is the modeled rsl at time ageAtSite[0], 
        # whose rsl is rslDataAtSite[0] 
    # so the difference between model and data rsl can be expressed as rslDataAtSite - rslModelAtSite[idx_rslModel]
    # the time of each element of this array is ageAtSites.
    
    
    # finally compute chi-square misfit for each site.
    err[idx_site] = np.mean(((rslDataAtSite - rslModelAtSite[idx_rslModel]) / rslDataError)**2)
    # rslModelAtSite[idx_rslModel] is the modelled rsl at this site
    # rslDataAtSite is data rsl at this site.
```


